---
AWSTemplateFormatVersion: "2010-09-09"

Description: >
  This CloudFormation template is meant to be used as nested stack to create a S3 bucket.

Metadata:
  AWS::CloudFormation::Interface:
    #Define user friendly Parameter Groups
    ParameterGroups:
      - Label:
          default: Storage Configuration
        Parameters:
          - pBucketName
      - Label:
          default: Project Configuration
        Parameters:
          - pProject
          - pEnv
    #Define user friendly names for the parameters
    ParameterLabels:
      pBucketName:
        default: Bucket name identifier
      pProject:
        default: Project name
      pEnv:
        default: Environment

Parameters:
  pBucketName:
    Description: >
      Bucket name will be generated by this identifier
    Type: String
  pProject:
    Description: The project name e.g. myp.
    Type: String
    Default: myp
  pEnv:
    Description: The environment identifier e.g. dev
    Type: String
    Default: dev

Resources:
  rPvtBucket:
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W35
            reason: sample
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      BucketName: !Sub "${pProject}-${pEnv}-${pBucketName}-${AWS::AccountId}-${AWS::Region}"
      AccessControl: Private
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        RestrictPublicBuckets: true
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
      Tags:
        - Key: Project
          Value: !Ref pProject
        - Key: Env
          Value: !Ref pEnv
        - Key: CreatedBy
          Value: !Ref AWS::StackId
  rPvtBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: rPvtBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: ForceSSLOnlyAccess
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !Sub "arn:${AWS::Partition}:s3:::${rPvtBucket}"
              - !Sub "arn:${AWS::Partition}:s3:::${rPvtBucket}/*"
            Condition:
              Bool:
                aws:SecureTransport: "false"
          - Sid: EnforceTLSv12orHigher
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !Sub "arn:${AWS::Partition}:s3:::${rPvtBucket}"
              - !Sub "arn:${AWS::Partition}:s3:::${rPvtBucket}/*"
            Condition:
              NumericLessThan:
                s3:TlsVersion: 1.2
